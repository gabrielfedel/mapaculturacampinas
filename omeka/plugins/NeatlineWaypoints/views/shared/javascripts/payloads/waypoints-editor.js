Neatline.module("Waypoints",function(a){a.Controller=Neatline.Shared.Controller.extend({slug:"WAYPOINTS",events:[{refresh:"load"},"highlight","unhighlight","select","unselect","setFilter","removeFilter"],init:function(){this.view=new a.View({slug:this.slug}),this.load()},load:function(){this.view.load()},highlight:function(a){this.view.renderHighlight(a.model)},unhighlight:function(a){this.view.renderUnhighlight(a.model)},select:function(a){this.view.renderSelect(a.model),this.view.scrollTo(a.model),this.unhighlight(a)},unselect:function(a){this.view.renderUnselect(a.model),this.unhighlight(a)},setFilter:function(a){this.view.setFilter(a.key,a.evaluator)},removeFilter:function(a){this.view.removeFilter(a.key)}})}),Neatline.module("Waypoints",function(a){a.addInitializer(function(){a.__controller=new a.Controller})}),Neatline.module("Waypoints",function(a){a.View=Neatline.Shared.Widget.View.extend({id:"waypoints",events:{"mouseenter a":"publishHighlight","mouseleave a":"publishUnhighlight","click a":"publishSelect"},options:{duration:200},init:function(a){this.slug=a.slug,this.model=null,this.filters={},this.template=_.template($("#waypoints-public-list-template").html()),this.records=new Neatline.Shared.Record.Collection},load:function(){var a={widget:"Waypoints",order:"weight"};this.records.update(a,_.bind(this.ingest,this))},ingest:function(){this.$el.toggleClass("empty",0==this.records.length),this.$el.html(this.template({records:this.records})),this.filter()},publishHighlight:function(a){this.publish("highlight",this.getModelByEvent(a))},publishUnhighlight:function(a){this.publish("unhighlight",this.getModelByEvent(a))},publishSelect:function(a){var b=this.getModelByEvent(a),c=this.model;c&&(this.publish("unselect",c),c.id==b.id)||this.publish("select",b)},renderHighlight:function(a){this.getElementById(a.id).addClass("highlighted")},renderUnhighlight:function(a){this.getElementById(a.id).removeClass("highlighted")},renderSelect:function(a){this.getElementById(a.id).addClass("selected"),this.model=a},renderUnselect:function(a){this.getElementById(a.id).removeClass("selected"),this.model=null},scrollTo:function(a){var b=this.getElementById(a.id)[0];b&&this.$el.animate({scrollTop:b.offsetTop},{duration:this.options.duration})},setFilter:function(a,b){this.filters[a]=b,this.filter()},removeFilter:function(a){delete this.filters[a],this.filter()},filter:function(){this.records.each(_.bind(function(a){var b=!0;_.each(this.filters,function(c){b=b&&c(a)}),this.getElementById(a.id).toggle(b)},this))},getModelByEvent:function(a){return this.records.get(Number($(a.currentTarget).attr("data-id")))},getElementById:function(a){return this.$("a[data-id="+a+"]")},publish:function(a,b){Neatline.vent.trigger(a,{model:b,source:this.slug})}})}),Neatline.module("Editor.Exhibit.Waypoints",function(a){a.Controller=Neatline.Shared.Controller.extend({slug:"EDITOR:WAYPOINTS",commands:["display"],init:function(){this.router=new a.Router,this.view=new a.View({slug:this.slug})},display:function(a){this.view.showIn(a),this.view.load()}})}),Neatline.module("Editor.Exhibit.Waypoints",function(a){a.addInitializer(function(){a.__controller=new a.Controller})}),Neatline.module("Editor.Exhibit.Waypoints",function(a){a.Router=Neatline.Shared.Router.extend({routes:{waypoints:"waypoints"},waypoints:function(){Neatline.execute("EDITOR:display",["EDITOR:EXHIBIT","EDITOR:WAYPOINTS"]),Neatline.execute("EDITOR:EXHIBIT:activateTab","waypoints")}})}),Neatline.module("Editor.Exhibit.Waypoints",function(a){a.View=Neatline.Shared.View.extend({template:"#waypoints-form-template",className:"form-stacked waypoints",tagName:"form",events:{'click a[name="save"]':"save"},ui:{save:'a[name="save"]',list:"div.sort"},init:function(a){this.slug=a.slug,this.template=_.template($("#waypoints-editor-list-template").html()),this.records=new Neatline.Shared.Record.Collection,this.__ui.list.sortable()},load:function(){var a={widget:"Waypoints",order:"weight"};this.records.update(a,_.bind(function(a){this.ingest(a)},this))},ingest:function(a){this.__ui.list.html(this.template({records:a})),a.length>0?this.enableSorting():this.disableSorting()},save:function(){0!=this.records.length&&$.ajax({data:JSON.stringify(this.getOrder()),url:Neatline.g.waypoints.order_api,success:_.bind(this.onSaveSuccess,this),error:_.bind(this.onSaveError,this),type:"POST"})},enableSorting:function(){this.__ui.list.sortable("enable"),this.__ui.save.removeClass("disabled")},disableSorting:function(){this.__ui.list.sortable("disable"),this.__ui.save.addClass("disabled")},getOrder:function(){return this.__ui.list.sortable("toArray",{attribute:"data-id"})},onSaveSuccess:function(){Neatline.vent.trigger("refresh",{source:this.slug}),Neatline.execute("EDITOR:notifySuccess",Neatline.g.waypoints.strings.order.save.success)},onSaveError:function(){Neatline.execute("EDITOR:notifyError",Neatline.g.waypoints.strings.order.save.error)}})});